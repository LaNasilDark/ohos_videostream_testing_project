<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H.264 视频流客户端</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .controls {
            padding: 20px;
            background-color: #ecf0f1;
            border-bottom: 1px solid #bdc3c7;
        }
        
        .control-group {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        
        .control-group label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        
        .control-group input, .control-group select {
            padding: 5px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }
        
        .btn {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .btn.disconnect {
            background-color: #e74c3c;
        }
        
        .btn.disconnect:hover {
            background-color: #c0392b;
        }
        
        .status {
            padding: 15px 20px;
            background-color: #34495e;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status-item {
            margin: 5px 0;
        }
        
        .video-container {
            padding: 20px;
            text-align: center;
            min-height: 400px;
            background-color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .video-display {
            max-width: 100%;
            max-height: 500px;
            border: 2px solid #34495e;
            border-radius: 4px;
            background-color: black;
        }
        
        .waiting-message {
            color: #bdc3c7;
            font-size: 18px;
            text-align: center;
        }
        
        .logs {
            height: 200px;
            overflow-y: auto;
            padding: 15px;
            background-color: #2c3e50;
            color: #ecf0f1;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-top: 1px solid #34495e;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
            border-bottom: 1px solid #34495e;
        }
        
        .log-timestamp {
            color: #3498db;
        }
        
        .log-info {
            color: #2ecc71;
        }
        
        .log-warning {
            color: #f39c12;
        }
        
        .log-error {
            color: #e74c3c;
        }
        
        .frame-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 4px;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>H.264 视频流客户端</h1>
            <p>实时接收和显示WebSocket视频流数据</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="serverUrl">服务器地址:</label>
                <input type="text" id="serverUrl" value="ws://localhost:8080" placeholder="ws://localhost:8080">
            </div>
            
            <div class="control-group">
                <label for="displayMode">显示模式:</label>
                <select id="displayMode">
                    <option value="decoded">解码图像</option>
                    <option value="both">原始+解码</option>
                </select>
            </div>
            
            <button id="connectBtn" class="btn">连接</button>
            <button id="disconnectBtn" class="btn disconnect" disabled>断开连接</button>
            <button id="clearLogsBtn" class="btn">清空日志</button>
        </div>
        
        <div class="status">
            <div class="status-item">
                <strong>连接状态:</strong> <span id="connectionStatus">未连接</span>
            </div>
            <div class="status-item">
                <strong>接收帧数:</strong> <span id="frameCount">0</span>
            </div>
            <div class="status-item">
                <strong>帧率:</strong> <span id="frameRate">0.0 fps</span>
            </div>
            <div class="status-item">
                <strong>数据量:</strong> <span id="dataReceived">0 KB</span>
            </div>
            <div class="status-item">
                <strong>最后更新:</strong> <span id="lastUpdate">-</span>
            </div>
        </div>
        
        <div class="video-container">
            <div id="videoContent">
                <div class="waiting-message">等待视频流连接...</div>
            </div>
        </div>
        
        <div id="frameInfo" class="frame-info" style="display: none;">
            <strong>当前帧信息:</strong><br>
            <span id="frameDetails"></span>
        </div>
        
        <div class="logs" id="logContainer">
            <div class="log-entry">
                <span class="log-timestamp">[启动]</span> 
                <span class="log-info">客户端已准备就绪，请点击连接按钮</span>
            </div>
        </div>
    </div>

    <script>
        class VideoStreamClient {
            constructor() {
                this.socket = null;
                this.isConnected = false;
                this.frameCount = 0;
                this.totalDataReceived = 0;
                this.startTime = null;
                this.lastFrameTime = null;
                this.frameRateBuffer = [];
                
                this.initializeElements();
                this.bindEvents();
            }
            
            initializeElements() {
                this.connectBtn = document.getElementById('connectBtn');
                this.disconnectBtn = document.getElementById('disconnectBtn');
                this.clearLogsBtn = document.getElementById('clearLogsBtn');
                this.serverUrlInput = document.getElementById('serverUrl');
                this.displayModeSelect = document.getElementById('displayMode');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.frameCountDisplay = document.getElementById('frameCount');
                this.frameRateDisplay = document.getElementById('frameRate');
                this.dataReceivedDisplay = document.getElementById('dataReceived');
                this.lastUpdateDisplay = document.getElementById('lastUpdate');
                this.videoContent = document.getElementById('videoContent');
                this.frameInfo = document.getElementById('frameInfo');
                this.frameDetails = document.getElementById('frameDetails');
                this.logContainer = document.getElementById('logContainer');
            }
            
            bindEvents() {
                this.connectBtn.addEventListener('click', () => this.connect());
                this.disconnectBtn.addEventListener('click', () => this.disconnect());
                this.clearLogsBtn.addEventListener('click', () => this.clearLogs());
                
                // 回车键连接
                this.serverUrlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.connect();
                    }
                });
            }
            
            connect() {
                if (this.isConnected) return;
                
                const url = this.serverUrlInput.value.trim();
                if (!url) {
                    this.addLog('请输入有效的WebSocket服务器地址', 'error');
                    return;
                }
                
                try {
                    this.addLog(`正在连接到 ${url}...`, 'info');
                    this.socket = new WebSocket(url);
                    
                    this.socket.onopen = (event) => {
                        this.isConnected = true;
                        this.startTime = Date.now();
                        this.frameCount = 0;
                        this.totalDataReceived = 0;
                        this.frameRateBuffer = [];
                        
                        this.updateConnectionStatus('已连接');
                        this.connectBtn.disabled = true;
                        this.disconnectBtn.disabled = false;
                        this.serverUrlInput.disabled = true;
                        
                        this.addLog('WebSocket连接成功', 'info');
                        this.showWaitingMessage('已连接，等待视频数据...');
                    };
                    
                    this.socket.onmessage = (event) => {
                        this.handleMessage(event.data);
                    };
                    
                    this.socket.onclose = (event) => {
                        this.handleDisconnection();
                        this.addLog(`连接已关闭 (代码: ${event.code})`, 'warning');
                    };
                    
                    this.socket.onerror = (error) => {
                        this.addLog('WebSocket连接错误', 'error');
                        this.handleDisconnection();
                    };
                    
                } catch (error) {
                    this.addLog(`连接失败: ${error.message}`, 'error');
                }
            }
            
            disconnect() {
                if (this.socket) {
                    this.socket.close();
                }
                this.handleDisconnection();
            }
            
            handleDisconnection() {
                this.isConnected = false;
                this.updateConnectionStatus('未连接');
                this.connectBtn.disabled = false;
                this.disconnectBtn.disabled = true;
                this.serverUrlInput.disabled = false;
                this.showWaitingMessage('连接已断开');
                this.frameInfo.style.display = 'none';
            }
            
            handleMessage(data) {
                try {
                    const message = JSON.parse(data);
                    this.frameCount++;
                    this.totalDataReceived += data.length;
                    
                    // 更新帧率计算
                    const now = Date.now();
                    if (this.lastFrameTime) {
                        this.frameRateBuffer.push(now);
                        // 保持最近1秒的数据用于计算帧率
                        this.frameRateBuffer = this.frameRateBuffer.filter(time => now - time <= 1000);
                    }
                    this.lastFrameTime = now;
                    
                    // 处理不同类型的消息
                    switch (message.type) {
                        case 'decoded_frame':
                            this.handleDecodedFrame(message);
                            break;
                        case 'complete_frame':
                            this.handleCompleteFrame(message);
                            break;
                        case 'frame':
                            this.handleRawFrame(message);
                            break;
                        default:
                            this.addLog(`收到未知消息类型: ${message.type}`, 'warning');
                    }
                    
                    this.updateStatistics();
                    
                } catch (error) {
                    this.addLog(`解析消息失败: ${error.message}`, 'error');
                }
            }
            
            handleDecodedFrame(message) {
                // 显示解码后的PNG图像
                const img = document.createElement('img');
                img.className = 'video-display';
                img.src = `data:image/png;base64,${message.data}`;
                img.onload = () => {
                    this.videoContent.innerHTML = '';
                    this.videoContent.appendChild(img);
                };
                
                this.updateFrameInfo({
                    type: '解码图像',
                    frameNumber: message.frameNumber,
                    width: message.width,
                    height: message.height,
                    format: message.format,
                    timestamp: message.timestamp
                });
                
                this.addLog(`接收解码帧: ${message.frameNumber} (${message.width}x${message.height})`, 'info');
            }
            
            handleCompleteFrame(message) {
                this.updateFrameInfo({
                    type: '完整H.264帧',
                    frameNumber: message.frameNumber,
                    frameType: message.frameType,
                    size: message.size,
                    timestamp: message.timestamp
                });
                
                this.addLog(`接收完整帧: ${message.frameNumber} [${message.frameType}] (${message.size}字节)`, 'info');
            }
            
            handleRawFrame(message) {
                this.updateFrameInfo({
                    type: '原始NALU',
                    nalType: message.nalType,
                    nalDesc: message.nalDesc,
                    size: message.size,
                    timestamp: message.timestamp
                });
                
                this.addLog(`接收NALU: 类型${message.nalType} [${message.nalDesc}] (${message.size}字节)`, 'info');
            }
            
            updateFrameInfo(info) {
                let details = '';
                Object.keys(info).forEach(key => {
                    details += `${key}: ${info[key]}\n`;
                });
                
                this.frameDetails.textContent = details;
                this.frameInfo.style.display = 'block';
            }
            
            updateStatistics() {
                this.frameCountDisplay.textContent = this.frameCount;
                
                // 计算帧率
                const frameRate = this.frameRateBuffer.length;
                this.frameRateDisplay.textContent = `${frameRate.toFixed(1)} fps`;
                
                // 计算数据量
                const dataKB = (this.totalDataReceived / 1024).toFixed(1);
                this.dataReceivedDisplay.textContent = `${dataKB} KB`;
                
                // 更新时间
                this.lastUpdateDisplay.textContent = new Date().toLocaleTimeString();
            }
            
            updateConnectionStatus(status) {
                this.connectionStatus.textContent = status;
                this.connectionStatus.style.color = status === '已连接' ? '#2ecc71' : '#e74c3c';
            }
            
            showWaitingMessage(message) {
                this.videoContent.innerHTML = `<div class="waiting-message">${message}</div>`;
            }
            
            addLog(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span> 
                    <span class="log-${type}">${message}</span>
                `;
                
                this.logContainer.appendChild(logEntry);
                this.logContainer.scrollTop = this.logContainer.scrollHeight;
                
                // 限制日志条目数量
                while (this.logContainer.children.length > 100) {
                    this.logContainer.removeChild(this.logContainer.firstChild);
                }
            }
            
            clearLogs() {
                this.logContainer.innerHTML = `
                    <div class="log-entry">
                        <span class="log-timestamp">[清空]</span> 
                        <span class="log-info">日志已清空</span>
                    </div>
                `;
            }
        }
        
        // 初始化客户端
        document.addEventListener('DOMContentLoaded', () => {
            new VideoStreamClient();
        });
    </script>
</body>
</html>
